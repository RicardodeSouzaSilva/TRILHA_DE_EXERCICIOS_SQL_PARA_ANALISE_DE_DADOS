/**********************************************************************************************
üéØ TRILHA DE EXERC√çCIOS ‚Äî SQL PARA AN√ÅLISE DE DADOS (PostgreSQL)
  - T√≥picos: INNER/LEFT/RIGHT JOIN, filtros sarg√°veis, DISTINCT, agrega√ß√µes

üìù Notas r√°pidas para avalia√ß√£o:
  ‚Ä¢ Use sempre aliases curtos e consistentes: a=autores, l=livros, lv=livros_vendidos.
  ‚Ä¢ Prefira filtros sarg√°veis (evite fun√ß√£o na coluna quando poss√≠vel).
  ‚Ä¢ Quando o enunciado pedir ‚Äúvendidos‚Äù, ancore em livros_vendidos (INNER JOIN).
  ‚Ä¢ Para ‚Äúincluir quem n√£o tem‚Ä¶‚Äù, mude a tabela √¢ncora e use LEFT JOIN.

-- ============================================================================================
-- üß© N√çVEL 1 ‚Äî FUNDAMENTOS E RECUPERA√á√ÉO DE DADOS
-- ============================================================================================

/*--------------------------------------------------------------------------------------------
Exerc√≠cio 1
Enunciado: Liste todos os livros vendidos e seus respectivos autores.
Interpreta√ß√£o: ‚Äúvendidos‚Äù implica existir registro em cap08.livros_vendidos,
logo usamos INNER JOINs (apenas quem tem venda aparece).
--------------------------------------------------------------------------------------------*/
SELECT
    a.nome            AS autor,
    l.titulo          AS titulo
FROM cap08.livros_vendidos AS lv           -- √¢ncora: somente registros com venda
INNER JOIN cap08.autores AS a
    ON a.id_autor = lv.id_autor
INNER JOIN cap08.livros AS l
    ON l.id_livro = lv.id_livro
ORDER BY a.nome, l.titulo;

-- Variante (evitar duplicatas do mesmo par autor√ólivro, se houver m√∫ltiplas vendas):
-- SELECT DISTINCT a.nome AS autor, l.titulo AS titulo
-- FROM cap08.livros_vendidos lv
-- JOIN cap08.autores a ON a.id_autor = lv.id_autor
-- JOIN cap08.livros  l ON l.id_livro = lv.id_livro
-- ORDER BY a.nome, l.titulo;


/*--------------------------------------------------------------------------------------------
Exerc√≠cio 2
Enunciado: Liste todos os autores e seus respectivos livros, incluindo autores que n√£o t√™m
livros cadastrados (ou sem vendas associadas).

Interpreta√ß√£o: todos os autores devem aparecer ‚Üí autores √© a √¢ncora (FROM autores)
e os relacionamentos s√£o LEFT JOIN.
--------------------------------------------------------------------------------------------*/
SELECT
    a.nome AS autor,
    COALESCE(l.titulo, 'Livro n√£o cadastrado') AS titulo
FROM cap08.autores AS a                      -- √¢ncora: todos os autores
LEFT JOIN cap08.livros_vendidos AS lv
    ON a.id_autor = lv.id_autor              -- mant√©m o autor mesmo sem vendas
LEFT JOIN cap08.livros AS l
    ON lv.id_livro = l.id_livro              -- tenta trazer o t√≠tulo; se n√£o houver, NULL
ORDER BY a.nome, l.titulo NULLS LAST;

-- Observa√ß√µes:
-- ‚Ä¢ Se houver m√∫ltiplas vendas do mesmo livro, voc√™ pode ver duplicatas.
--   Para deduplicar pares (autor, t√≠tulo):
--   SELECT DISTINCT a.nome, COALESCE(l.titulo, 'Livro n√£o cadastrado') ...
-- ‚Ä¢ Para contar vendas por (autor, livro), adicione COUNT(*) e GROUP BY nas colunas cruas.


/*--------------------------------------------------------------------------------------------
Exerc√≠cio 3
Enunciado: Liste todos os livros e seus respectivos autores, incluindo livros que n√£o t√™m
autores cadastrados/associados (via vendas).

Interpreta√ß√£o: todos os livros devem aparecer ‚Üí livros √© a √¢ncora; autor entra se houver
venda relacionada ‚Üí LEFT JOINs a partir de livros.
--------------------------------------------------------------------------------------------*/
SELECT DISTINCT
    COALESCE(a.nome, 'Autor n√£o cadastrado') AS autor,
    l.titulo                                  AS titulo
FROM cap08.livros AS l                        -- √¢ncora: todos os livros
LEFT JOIN cap08.livros_vendidos AS lv
    ON lv.id_livro = l.id_livro
LEFT JOIN cap08.autores AS a
    ON a.id_autor = lv.id_autor
ORDER BY autor, l.titulo;

-- Observa√ß√£o: DISTINCT evita m√∫ltiplas linhas para o mesmo par (autor, livro)
-- quando houver v√°rias vendas.


/*--------------------------------------------------------------------------------------------
Exerc√≠cio 4
Enunciado: Liste os autores que nasceram antes de 1970 e os livros que eles escreveram.

Interpreta√ß√£o: filtramos autores (< 1970) e mostramos apenas livros com venda registrada.
Para performance, use filtro sarg√°vel em data_nascimento.
--------------------------------------------------------------------------------------------*/
SELECT
    a.nome AS autor,
    EXTRACT(YEAR FROM a.data_nascimento) AS ano_nascimento,
    l.titulo AS titulo
FROM cap08.livros_vendidos AS lv
INNER JOIN cap08.autores AS a
    ON a.id_autor = lv.id_autor
INNER JOIN cap08.livros AS l
    ON l.id_livro = lv.id_livro
WHERE a.data_nascimento < DATE '1970-01-01'           -- sarg√°vel (usa √≠ndice em data_nascimento)
ORDER BY a.nome, l.titulo;

-- Observa√ß√£o:
-- ‚Ä¢ Evite WHERE EXTRACT(YEAR FROM a.data_nascimento) < 1970, pois aplica fun√ß√£o na coluna
--   e pode impedir uso de √≠ndice.
-- ‚Ä¢ Se quiser deduplicar (autor, livro), use DISTINCT.


/*--------------------------------------------------------------------------------------------
Exerc√≠cio 5
Enunciado: Liste os livros publicados ap√≥s 2017, incluindo os que n√£o t√™m autores associados.

Interpreta√ß√£o: todos os livros com ano_publicacao > 2017 devem aparecer ‚Üí livros √© a √¢ncora,
e os autores entram via vendas se houver. Se ano_publicacao for INTEGER, compare como n√∫mero.
--------------------------------------------------------------------------------------------*/
SELECT
  COALESCE(a.nome, 'Autor n√£o cadastrado') AS autor,
  l.titulo,
  l.ano_publicacao
FROM cap08.livros AS l                        -- √¢ncora: todos os livros
LEFT JOIN cap08.livros_vendidos AS lv
  ON lv.id_livro = l.id_livro
LEFT JOIN cap08.autores AS a
  ON a.id_autor = lv.id_autor
WHERE l.ano_publicacao > 2017                 -- sarg√°vel (se INTEGER)
ORDER BY l.titulo;

-- Se l.ano_publicacao for DATE/TIMESTAMP, prefira:
-- WHERE l.ano_publicacao >= DATE '2018-01-01'

 
